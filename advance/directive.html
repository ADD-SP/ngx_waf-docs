<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Directive | ngx_waf</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/ADD-SP/ngx_waf@master/assets/logo.png">
    <meta name="description" content="A web application firewall module for nginx without complex configuration.&#39;">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex, noodp, notranslate, max-video-preview:-1">
    
    <link rel="preload" href="/ngx_waf-docs/assets/css/0.styles.692fb11e.css" as="style"><link rel="preload" href="/ngx_waf-docs/assets/js/app.18b0a3f1.js" as="script"><link rel="preload" href="/ngx_waf-docs/assets/js/2.3e4049ee.js" as="script"><link rel="preload" href="/ngx_waf-docs/assets/js/1.632eea70.js" as="script"><link rel="preload" href="/ngx_waf-docs/assets/js/23.3534e7c2.js" as="script"><link rel="preload" href="/ngx_waf-docs/assets/js/4.14d7d714.js" as="script"><link rel="prefetch" href="/ngx_waf-docs/assets/js/10.dbe56695.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/11.3ce229d2.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/12.6df2a13c.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/13.2fbc14fb.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/14.79f0bc94.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/15.a9c75a53.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/16.90f412f5.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/17.5a0da591.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/18.00741604.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/19.2df6684e.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/20.e4d75808.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/21.0376e09e.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/22.8cd93f05.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/24.542f1cdb.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/25.a81f82fc.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/26.518e0279.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/27.9e1df40c.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/28.6a196960.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/29.f98a7279.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/3.c9caeb98.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/30.47624d64.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/31.1c13a39c.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/32.5fe17366.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/33.f0d975ea.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/34.78aa9f6f.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/35.e7283fb6.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/36.f394b95e.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/37.2a10db91.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/38.2f464d46.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/39.98a34cfd.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/40.07bcf6b0.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/41.d175aa1e.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/42.41c12642.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/43.692e3aac.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/44.89739f3f.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/45.e4fd3ab6.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/46.e62f6898.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/47.ab95c6c5.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/48.c7530b9a.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/49.0249b3b4.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/5.aa966c18.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/50.775910db.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/51.44550aa5.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/52.24cf39ae.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/53.78cfc18d.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/54.fd108f23.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/55.a9734a43.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/56.dabfbc19.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/57.674c5c64.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/58.439ffb3f.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/59.83d2cd2d.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/6.63e6a7bb.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/60.c62e8958.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/61.351cad9c.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/62.135948fd.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/63.a59ca98e.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/64.a63032c9.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/65.b30eba0a.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/66.c4e0ff1d.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/67.98a6c2e2.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/68.ec463ee0.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/69.210eed00.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/7.a02e05ba.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/70.de7d7876.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/71.fbb3679c.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/72.cb3c8b40.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/73.df3dbfd5.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/74.f9f9a7b5.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/75.c5d27717.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/76.a123d687.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/77.8447f073.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/78.5465da14.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/79.c5642884.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/80.2c31ee90.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/81.b68da930.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/82.d8bb7f68.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/83.71fa47bc.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/vendors~docsearch.e06e619e.js">
    <link rel="stylesheet" href="/ngx_waf-docs/assets/css/0.styles.692fb11e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ngx_waf-docs/" class="home-link router-link-active"><!----> <span class="site-name">ngx_waf</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/ngx_waf-docs/practice/overview.html" class="nav-link">
  Best Practices
</a></div><div class="nav-item"><a href="/ngx_waf-docs/advance/upgrade.html" class="nav-link">
  Cross-version Upgrades
</a></div><div class="nav-item"><a href="/ngx_waf-docs/changes/overview.html" class="nav-link">
  CHANGES
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ngx_waf-docs/advance/directive.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/ngx_waf-docs/zh-cn/advance/directive.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/ADD-SP/ngx_waf/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/ngx_waf-docs/practice/overview.html" class="nav-link">
  Best Practices
</a></div><div class="nav-item"><a href="/ngx_waf-docs/advance/upgrade.html" class="nav-link">
  Cross-version Upgrades
</a></div><div class="nav-item"><a href="/ngx_waf-docs/changes/overview.html" class="nav-link">
  CHANGES
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ngx_waf-docs/advance/directive.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/ngx_waf-docs/zh-cn/advance/directive.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/ADD-SP/ngx_waf/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf-docs/guide/overview.html" class="sidebar-heading clickable"><span>Quick Start</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf-docs/advance/directive.html" aria-current="page" class="sidebar-heading clickable router-link-exact-active router-link-active open active"><span>Advanced Guide</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/ngx_waf-docs/advance/directive.html" aria-current="page" class="active sidebar-link">Directive</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf" class="sidebar-link">waf</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-zone" class="sidebar-link">waf_zone</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-rule-path" class="sidebar-link">waf_rule_path</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-mode" class="sidebar-link">waf_mode</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-cc-deny" class="sidebar-link">waf_cc_deny</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-cache" class="sidebar-link">waf_cache</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-modsecurity" class="sidebar-link">waf_modsecurity</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-modsecurity-transaction-id" class="sidebar-link">waf_modsecurity_transaction_id</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-captcha" class="sidebar-link">waf_captcha</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-verify-bot" class="sidebar-link">waf_verify_bot</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-under-attack" class="sidebar-link">waf_under_attack</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-priority" class="sidebar-link">waf_priority</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-http-status" class="sidebar-link">waf_http_status</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-action" class="sidebar-link">waf_action</a></li><li class="sidebar-sub-header"><a href="/ngx_waf-docs/advance/directive.html#waf-block-page" class="sidebar-link">waf_block_page</a></li></ul></li><li><a href="/ngx_waf-docs/advance/rule.html" class="sidebar-link">Rule Description</a></li><li><a href="/ngx_waf-docs/advance/priority.html" class="sidebar-link">Rule Priority</a></li><li><a href="/ngx_waf-docs/advance/variable.html" class="sidebar-link">Embedded Variables</a></li><li><a href="/ngx_waf-docs/advance/log.html" class="sidebar-link">Log</a></li><li><a href="/ngx_waf-docs/advance/upgrade.html" class="sidebar-link">Cross-version Upgrades</a></li><li><a href="/ngx_waf-docs/advance/issue.html" class="sidebar-link">Known Issues</a></li></ul></section></li><li><a href="/ngx_waf-docs/roadmap/overview.html" class="sidebar-link">Roadmap (Advice Needed)</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="directive"><a href="#directive" class="header-anchor">#</a> Directive</h1> <h2 id="waf"><a href="#waf" class="header-anchor">#</a> <code>waf</code></h2> <ul><li>syntax: waf &lt;<em>on</em> | <em>off</em> | <em>bypass</em> &gt;</li> <li>default: waf <em>off</em></li> <li>context: http, server, location</li></ul> <p>enable, disable or bypass.</p> <ul><li>on: enable</li> <li>off: disable</li> <li>bypass: only inspect and record logs, without blocking any requests.</li></ul> <h2 id="waf-zone"><a href="#waf-zone" class="header-anchor">#</a> <code>waf_zone</code> <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>&gt;=v10.0.0</span></h2> <ul><li>syntax: waf_zone &lt;name=<em>zone_name</em>&gt; [size=<em>5m</em>]</li> <li>default: —</li> <li>context: http</li></ul> <p>Creates a piece of shared memory to record some information that needs to be shared across processes because of nginx's multi-process model.</p> <p>You may need to fill in the parameter <code>zone</code> when you use certain directive, such as <a href="#waf-cc-deny">waf_cc_deny</a>.
The fill format is <code>name:tag</code>, i.e. name and tag. Name and tag are &quot;many-to-many&quot;, but for the same <code>zone</code>, the
tag names cannot be repeated for the same <code>zone</code>.</p> <p>All tags within the same <code>zone</code> share the entire shared memory of that <code>zone</code>. For performance reasons, it is recommended that one <code>zone</code> be created for each <code>server</code> context.
It is better not to have multiple <code>server</code> context sharing a single <code>zone</code>, because accessing shared memory requires locking, so minimize the number of locking.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>1MB of memory can record at least 4096 IP.</p></div> <h2 id="waf-rule-path"><a href="#waf-rule-path" class="header-anchor">#</a> <code>waf_rule_path</code></h2> <ul><li>syntax: waf_rule_path &lt;<em>dir</em>&gt;</li> <li>default: —</li> <li>context: http, server, location</li></ul> <p>The absolute path to the directory where the rule file is located, and must end with <code>/</code>.</p> <h2 id="waf-mode"><a href="#waf-mode" class="header-anchor">#</a> <code>waf_mode</code></h2> <ul><li>syntax: waf_mode &lt;<em>mode_type</em>&gt; ...</li> <li>default: —</li> <li>context: http, server, location</li></ul> <p>Specify the working mode of the firewall, specifying at least one mode and up to eight modes.</p> <p><code>mode_type</code> has the following values (not case sensitive):</p> <ul><li>GET: Start the inspection process when <code>Http.Method=GET</code>.</li> <li>HEAD: Start the inspection process when <code>Http.Method=HEAD</code>.</li> <li>POST: Start the inspection process when <code>Http.Method=POST</code>.</li> <li>PUT: Start the inspection process when <code>Http.Method=PUT</code>.</li> <li>DELETE: Start the inspection process when <code>Http.Method=DELETE</code>.</li> <li>MKCOL: Start the check process when <code>Http.Method=MKCOL</code>.</li> <li>COPY: Start the inspection process when <code>Http.Method=COPY</code>.</li> <li>MOVE: Start the inspection process when <code>Http.Method=MOVE</code>.</li> <li>OPTIONS: Start the inspection process when <code>Http.Method=OPTIONS</code>.</li> <li>PROPFIN: Start the inspection process when <code>Http.Method=PROPFIN</code>.</li> <li>PROPPATCH: Start the inspection process when <code>Http.Method=PROPPATCH</code>.</li> <li>LOCK: Start the inspection process when <code>Http.Method=LOCK</code>.</li> <li>UNLOCK: Start the inspection process when <code>Http.Method=UNLOCK</code>.</li> <li>PATCH: Start the inspection process when <code>Http.Method=PATCH</code>.</li> <li>TRAC: Start the inspection process when <code>Http.Method=TRAC</code>.</li> <li>CMN-METH: Equivalent to <code>HEAD GET POST</code>.</li> <li>ALL-METH: Any HTTP request method will start the inspection process.</li> <li>IP: Enable IP address inspecting rules.</li> <li>URL: Enable URL inspecting rules.</li> <li>RBODY: Enable POST request body inspecting rules.</li> <li>ARGS: Enable ARGS inspecting rules.</li> <li>UA: Enable UA inspecting rules.</li> <li>COOKIE: Enable COOKIE inspecting rules.</li> <li>REFERER: Enable REFERER inspecting rules.</li> <li>CC: Enable 'Anti Challenge Collapsar'. <strong>When you enable this mode, you must set <a href="#waf-cc-deny">waf_cc_deny</a></strong>.</li> <li>ADV: Enable the advanced rules.</li> <li>LIB-INJECTION-SQLI: Use <a href="https://github.com/libinjection/libinjection" target="_blank" rel="noopener noreferrer">libinjection<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to detect SQL injection.</li> <li>LIB-INJECTION-XSS: Use <a href="https://github.com/libinjection/libinjection" target="_blank" rel="noopener noreferrer">libinjection<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to detect XSS attacks.</li> <li>LIB-INJECTION: Equivalent to <code>LIB-INJECTION-SQLI LIB-INJECTION-XSS</code>.</li> <li>CACHE: Enable caching. Enabling this mode will cache the result of the inspection, so that the next time the same target is inspected, there is no need to repeat the inspection. However, the results of the POST body inspection are not cached. For example, if a URL is not in the blacklist after inspection, the next time the same URL is inspected, the cache can be read directly. <strong>When you enable this mode, you must set <a href="#waf-cache">waf_cache</a></strong>.</li> <li>STD: Standard working mode, equivalent to <code>HEAD GET POST IP URL RBODY ARGS UA CC CACHE LIB-INJECTION-SQLI</code>.</li> <li>STATIC: working mode for static sites, equivalent to <code>HEAD GET IP URL UA CC CACHE</code>.</li> <li>DYNAMIC: working mode for dynamic sites, equivalent to <code>HEAD GET POST IP URL ARGS UA RBODY COOKIE CC CACHE LIB-INJECTION-SQLI</code>.</li> <li>FULL: Enable all modes.</li> <li>[DATA EXPUNGED]: This mode [DATA EXPUNGED].</li></ul> <p>You can turn off a mode by prefixing <code>mode_type</code> with the prefix <code>!</code> to turn off a mode.
The following is an example of using the standard working mode, but without inspecting the User-Agent.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">waf_mode</span> STD !UA</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">NOTE</p> <p>If two or more conflicting modes are enabled at the same time, the mode to the right will override the mode to its left. The following example means inspecting the User-Agent.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">waf_mode</span> !UA STD</span><span class="token punctuation">;</span>
</code></pre></div></div> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The mode of <code>CC</code> is independent of other modes, and whether it takes effect or not is not affected by other modes. A typical situation such as the <code>URL</code> mode will be affected by the <code>GET</code> mode, because if the <code>GET</code> mode is not used, the check will not be started when <code>Http.Method=GET</code>, and the URL will naturally not be inspected, but <code>CC</code> mode will not be similarly affected.</p></div> <div class="custom-block tip"><p class="custom-block-title">CHANGES IN LATEST 'Current' VERSION</p> <p>The parameters <code>CC</code> and <code>CACHE</code> are removed.</p> <ul><li>STD: Standard working mode, equivalent to <code>HEAD GET POST IP URL RBODY ARGS UA</code>.</li> <li>STATIC: working mode for static sites, equivalent to <code>HEAD GET IP URL UA</code>.</li> <li>DYNAMIC: working mode for dynamic sites, equivalent to <code>HEAD GET POST IP URL ARGS UA RBODY COOKIE</code>.</li> <li>LIB-INJECTION: Removed.</li> <li>LIB-INJECTION-SQLI: Removed.</li> <li>LIB-INJECTION-XSS: Removed.</li> <li>ADV: Removed.</li></ul></div> <h2 id="waf-cc-deny"><a href="#waf-cc-deny" class="header-anchor">#</a> <code>waf_cc_deny</code></h2> <ul><li>syntax: waf_cc_deny &lt;rate=<em>n</em>r/m&gt; [duration=<em>1h</em>] [size=<em>20m</em>]</li> <li>default: —</li> <li>context: http, server, location</li></ul> <p>Set the parameters related to CC protection.</p> <ul><li><code>rate</code>: Indicates the upper limit of the number of requests over a period of time, such as <code>500r/m</code>. Exceeding the limit returns a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/503" target="_blank" rel="noopener noreferrer">503 status code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> with a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Retry-After" target="_blank" rel="noopener noreferrer">Retry-After<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> response header.</li> <li><code>duration</code>: Indicates the time to block IP after exceeding the limit of the first parameter <code>rate</code>, such as <code>60s</code>, <code>60m</code>, <code>60h</code> and <code>60d</code>, if not specified, the default is <code>1h</code>.</li> <li><code>size</code>: Used to set the size of the memory for recording IP accesses, such as <code>20m</code>, <code>2048k</code>, must not be less than <code>20m</code>, if not specified, the default is <code>20m</code>. When this memory is exhausted, the program will clean up some of the records according to the LRU policy.</li></ul> <div class="custom-block tip"><p class="custom-block-title">CHANGES IN LATEST 'Current' VERSION</p> <ul><li>syntax:  waf_cc_deny &lt;<em>off</em> | <em>on</em>&gt; &lt;rate=<em>n</em>r/t&gt; &lt;zone=<em>name:tag</em>&gt; [duration=<em>1h</em>]</li> <li>default: waf_cc_deny <em>off</em></li> <li>context: server, location</li></ul> <hr> <ul><li><code>zone</code>: Set the shared memory used to record the necessary information.</li> <li><code>rate</code>: indicates the upper rate of requests, such as <code>500r/s</code>, <code>500r/60s</code>, <code>500r/m</code>, <code>500r/60m</code>, <code>500r/h</code>, <code>500r/60h</code> and <code>500r/d</code>. Exceeding the limit returns a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/503" target="_blank" rel="noopener noreferrer">503 status code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> with a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Retry-After" target="_blank" rel="noopener noreferrer">Retry-After<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> response header.</li></ul></div> <h2 id="waf-cache"><a href="#waf-cache" class="header-anchor">#</a> <code>waf_cache</code></h2> <ul><li>syntax: waf_cache &lt;capacity=<em>n</em>&gt;</li> <li>default: —</li> <li>context: http, server, location</li></ul> <p>Set the parameters related to cache rule inspection results.</p> <ul><li><code>capacity</code>: For some inspection items with caching mechanism enabled, the maximum number of inspection results per inspection item to be cached for each inspection target.</li></ul> <div class="custom-block tip"><p class="custom-block-title">Cache-enabled inspections</p> <p>Cache-enabled inspections refer to all inspections except CC protection, I
P black and white list inspection, and POST inspection.</p></div> <div class="custom-block tip"><p class="custom-block-title">Performance optimization suggestions</p> <p>Too small a <code>capacity</code> will result in frequent cache cleanups,
increasing memory fragmentation and reducing performance.
So please set it reasonably according to your actual needs.</p></div> <div class="custom-block tip"><p class="custom-block-title">CHANGES IN LATEST 'Current' VERSION</p> <ul><li>syntax: waf_cache &lt;<em>off</em> | <em>on</em>&gt; [capacity=<em>50</em>]</li> <li>default: waf_cache <em>off</em> capacity=<em>50</em></li> <li>context: server, location</li></ul></div> <h2 id="waf-modsecurity"><a href="#waf-modsecurity" class="header-anchor">#</a> <code>waf_modsecurity</code> <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>Latest Current version only</span></h2> <ul><li>syntax: waf_modsecurity &lt;<em>on</em> | <em>off</em>&gt; &lt;file=*/path/to/modsecuriy/rules.conf*&gt; &lt;remote_key=<em>key</em>&gt; &lt;remote_url=<em>url</em>&gt;</li> <li>default: waf_modsecurity off</li> <li>context: http, server, location</li></ul> <p>Use ModSecurity's rules.</p> <ul><li><code>file</code>: absolute path to the rule file.</li> <li><code>remote_key</code>: key for reading remote rule file.</li> <li><code>remote_url</code>: URL to read the remote file.</li></ul> <p>You can refer to the use case in <a href="/ngx_waf-docs/practice/enable-modsecurity.html">Enable ModSecurity | Best Practices</a>.</p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <ul><li>If you use the parameter <code>remote_key</code>, you must also use the parameter <code>remote_url</code>.</li> <li>If you use the parameters <code>file</code>, <code>remote_key</code> and <code>remote_url</code> at the same time, then both rules will be loaded.</li></ul></div> <div class="custom-block danger"><p class="custom-block-title">MEMORY LEAKS</p> <p><strong>Memory leaks can cause the system to have less and less memory available, degrade performance, and possibly cause programs or systems to crash.</strong></p> <p>The latest version v3.0.5 of <a href="https://github.com/SpiderLabs/ModSecurity" target="_blank" rel="noopener noreferrer">ModSecurity<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> has a memory leak bug.</p> <ul><li><a href="https://github.com/SpiderLabs/ModSecurity/issues/2552" target="_blank" rel="noopener noreferrer">ngin reload memory leak - Issue #2552 - SpiderLabs/ModSecurity<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/SpiderLabs/ModSecurity/issues/2502" target="_blank" rel="noopener noreferrer">It often leads memory leak on nginx reload - Issue #2502 - SpiderLabs/ModSecurity<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>If you have ModSecurity enabled, memory leaks can occur when reloading nginx, which can have serious consequences in the long run.</p> <p>We strongly recommend that you avoid using commands like the following.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>nginx <span class="token parameter variable">-s</span> reload
systemctl restart nginx
<span class="token function">service</span> nginx restart
</code></pre></div><p>When you need to reload nginx, it is highly recommended to shut down nginx first and then start nginx.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>nginx <span class="token parameter variable">-s</span> stop <span class="token operator">&amp;&amp;</span> nginx
systemctl stop nginx <span class="token operator">&amp;&amp;</span> systemctl start nginx
<span class="token function">service</span> nginx stop <span class="token operator">&amp;&amp;</span> serivce nginx start
</code></pre></div></div> <h2 id="waf-modsecurity-transaction-id"><a href="#waf-modsecurity-transaction-id" class="header-anchor">#</a> <code>waf_modsecurity_transaction_id</code> <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>Latest Current version only</span></h2> <ul><li>Configuration syntax: waf_modsecurity_transaction_id &lt;<em>string</em>&gt;</li> <li>Default configuration: waf_modsecurity off</li> <li>Configuration segments: http, server, location</li></ul> <p>Specify the transaction ID for ModSecurity. you can use constant strings and variables here, here is an example.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">location</span> /file/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">waf_modsecurity_transaction_id</span> <span class="token string">&quot;<span class="token variable">$host</span>-file&quot;</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> /api/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">waf_modsecurity_transaction_id</span> <span class="token string">&quot;<span class="token variable">$host</span>-api&quot;</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="waf-captcha"><a href="#waf-captcha" class="header-anchor">#</a> <code>waf_captcha</code> <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>Latest Current version only</span></h2> <ul><li>syntax: waf_captcha &lt;<em>on</em> | <em>off</em>&gt; &lt;prov=<em>hCaptcha</em> | <em>reCAPTCHAv2:checkbox</em> | <em>reCAPTCHAv2:invisible</em> | <em>reCAPTCHAv3</em>&gt; [file=<em>/full/path</em>] [sitekey=<em>your_sitekey</em>] &lt;secret=<em>your_secret</em>&gt; [score=<em>0.5</em>] [expire=30m] [api=<em>uri</em>] [verify=<em>/captcha</em>] [max_fails=<em>times:duration</em>] [zone=<em>name:tag</em>]</li> <li>default: waf_captcha off</li> <li>context: http, server, location</li></ul> <p>Use CAPTCHA for human identification of the client.</p> <ul><li><code>prov</code>: CAPTCHA platform with <a href="https://www.hcaptcha.com/" target="_blank" rel="noopener noreferrer">hCaptcha<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://www.google.com/recaptcha/about/" target="_blank" rel="noopener noreferrer">reCAPTCHAv2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://www.google.com/recaptcha/about/" target="_blank" rel="noopener noreferrer">reCAPTCHAv3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li><code>file</code>: The absolute path to the HTML file used to access the captcha, you can find the corresponding HTML file under <code>assets/</code> and fill in your <code>sitekey</code> in the file. If you omit this parameter, a built-in HTML file (from the directory <code>assets/</code>) will be selected and used based on the value of the parameter <code>prov</code>, where you need to set the parameter <code>sitekey</code>.</li> <li><code>sitekey</code>: the sitekey you get from the captcha platform, this parameter needs to be set if and only if the parameter <code>file</code> is omitted.</li> <li><code>secret</code>: the key used to confirm the result of the CAPTCHA, you can get it from the corresponding CAPTCHA platform.</li> <li><code>socre</code>: when <code>prov=reCAPTCHAv3</code>, this indicates the minimum value of the CAPTCHA scoring result, below which the validation will be considered as failed. The default value is <code>0.5</code>.</li> <li><code>expire</code>: the expiration time of the CAPTCHA, after which the CAPTCHA needs to be re-run. The default is 30 minutes.</li> <li><code>api</code>: The API provided by the CAPTCHA platform to the server to confirm the result of the CAPTCHA run.
<ul><li>If <code>prov=hCaptcha</code>, the default value is <code>https://hcaptcha.com/siteverify</code>.</li> <li>If <code>prov=reCAPTCHAv2:xxx</code>, then the default value is <code>https://www.recaptcha.net/recaptcha/api/siteverify</code>.</li> <li>If <code>prov=reCAPTCHAv3</code>, the default value is <code>https://www.recaptcha.net/recaptcha/api/siteverify</code>.</li></ul></li> <li><code>verify</code>: the url used by the captcha to submit the token to the backend, defaults to <code>/captcha</code>.</li> <li><code>max_fails</code>: The maximum number of times the CAPTCHA can be refreshed/tried, beyond which the corresponding IP is blacked out for a period of time. For example, <code>max_fails=20:5m</code> means that the IP will be blacked out for 5 minutes after 20 consecutive refreshes/tries. This is useful when you are using billing CAPTCHA. When you set this parameter, you must also set the parameter <code>zone</code>.</li> <li><code>zone</code>: Set the shared memory used to record the number of CAPTCHA tries, this parameter is required if and only if parameter <code>max_fails</code> is set.</li></ul> <p>You can refer to the use case in <a href="/ngx_waf-docs/practice/enable-captcha.html">Enable Captcha | Best Practices</a>.</p> <div class="custom-block tip"><p class="custom-block-title">Use your own CAPTCHA page</p> <p>You can customize the captcha page based on the HTML file under the directory <code>assets/</code> and load it with the parameter <code>file</code>.</p> <p>Don't forget to fill in the <code>sitekey</code> in the HTML file.</p></div> <h2 id="waf-verify-bot"><a href="#waf-verify-bot" class="header-anchor">#</a> <code>waf_verify_bot</code> <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>Latest Current version only</span></h2> <ul><li>syntax: waf_verify_bot &lt;<em>off</em> | <em>on</em> | <em>strict</em>&gt; [<em>who</em>] ...</li> <li>default: waf_verify_bot <em>off</em> <em>GoogleBot</em> <em>BingBot</em> <em>BaiduSpider</em> <em>YandexBot</em> <em>SogouSpider</em></li> <li>context: http, server, location</li></ul> <p>Verify friendly crawlers, such as GoogleBot.</p> <p>If the first parameter is <code>on</code> then all subsequent checks will be stopped and the request will be released.</p> <p>If the first parameter is <code>strict</code>, then if the User-Agent of a request is correct, but the IP address is incorrect, it will be blocked (with false positives).</p> <ul><li><code>who</code>: the name of the crawler, values include <code>GoogleBot</code>, <code>BingBot</code>, <code>BaiduSpider</code>, <code>YandexBot</code> and <code>SogouSpider</code>. If not specified, the default is all.</li></ul> <div class="custom-block tip"><p class="custom-block-title">HOW IT WORKS?</p> <ul><li><a href="https://developers.google.com/search/docs/advanced/crawling/overview-google-crawlers" target="_blank" rel="noopener noreferrer">Overview of Google crawlers (user agents) | Search Central<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developers.google.com/search/docs/advanced/crawling/verifying-googlebot" target="_blank" rel="noopener noreferrer">Googlebot Verification | Google Search Central | Google Developers<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.bing.com/webmasters/help/which-crawlers-does-bing-use-8c184ec0" target="_blank" rel="noopener noreferrer">Which Crawlers Does Bing Use? - Bing Webmaster Tools<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.bing.com/webmasters/help/how-to-verify-bingbot-3905dc26" target="_blank" rel="noopener noreferrer">How to Verify Bingbot<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://help.baidu.com/question?prod_id=99&amp;class=0&amp;id=3001" target="_blank" rel="noopener noreferrer">百度用户服务中心-站长平台<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://yandex.com/support/webmaster/robot-workings/check-yandex-robots.html" target="_blank" rel="noopener noreferrer">How to check that a robot belongs to Yandex<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhanzhang.sogou.com/index.php/help/spider" target="_blank" rel="noopener noreferrer">搜狗资源平台_公平开放的交流平台<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <h2 id="waf-under-attack"><a href="#waf-under-attack" class="header-anchor">#</a> <code>waf_under_attack</code></h2> <ul><li>syntax: waf_under_attack &lt;<em>on</em> | <em>off</em>&gt; [uri=<em>str</em>]</li> <li>default: waf_under_attack off</li> <li>context: http, server, location</li></ul> <p>If your site is under attack you can try using this directive.
Turning it on forces a five-second delay on each user's first visit and automatically jumps to the page pointed to by <code>uri</code>.</p> <ul><li><code>uri</code>: can be a full URL or a path. For example, <code>https://example.com/attack.html</code> or <code>/attack.html</code>.</li></ul> <p>You can refer to the use case in <a href="/ngx_waf-docs/practice/protect-against-distributed-http-flood.html">protect against distributed CC Attacks (distributed HTTP flooding) | Best Practices</a>.</p> <div class="custom-block tip"><p class="custom-block-title">Tips</p> <p>The page pointed to by <code>uri</code> should automatically jump to the page the user wants to visit after five seconds, the URL of the page can be obtained by querying a string with the parameter <code>target</code>.</p> <p><code>assets/under-attack.html</code> is a sample page, you should copy this file to your web directory and configure <code>uri</code> correctly.</p> <p>Naturally, you can also write your own html file and point to it with <code>uri</code>.</p></div> <div class="custom-block tip"><p class="custom-block-title">CHANGES IN LATEST 'Current' VERSION</p> <p>In the LTS version we implemented this feature through redirects, but many reasons (such as caching and CDN) would cause the redirects to fail or not validate the cookie properly.
So we changed the implementation so that we return the specified page by changing the response body in a way that does not cause the URI to change.</p> <p>We also added the response header <code>Cache-Control: no-store</code> to avoid the impact of caching.</p> <ul><li><p>synyax: waf_under_attack &lt;<em>on</em> | <em>off</em>&gt; [file=<em>full_path</em>]</p></li> <li><p>default: waf_under_attack <em>off</em></p></li> <li><p>context: http, server, location</p></li> <li><p>Removed the parameter <code>uri</code>.</p></li> <li><p>Added parameter <code>file</code>, the value of this parameter should be the absolute path to an HTML file, e.g. <code>file=/path/to/under-attack.html</code>. This HTML has only one function, which is to refresh automatically after five seconds. When you omit this parameter, the default is to use the built-in HTML file, which comes from <code>assets/under-attack.html</code>.</p></li></ul></div> <h2 id="waf-priority"><a href="#waf-priority" class="header-anchor">#</a> <code>waf_priority</code></h2> <ul><li>syntax: waf_priority &quot;<em>str</em>&quot;</li> <li>default: waf_priority &quot;W-IP IP CC UNDER-ATTACK W-URL URL ARGS UA W-REFERER REFERER COOKIE ADV&quot;</li> <li>context: http, server, location</li></ul> <p>Set the priority of each inspection process, except for POST detection, which always has the lowest priority.</p> <ul><li><code>UNDER-ATTACK</code>: Directive <code>waf_under_attack</code>.</li> <li><code>W-IP</code>: IP whitelist inspection</li> <li><code>IP</code>: IP Blacklist inspection</li> <li><code>CC</code>: CC protection</li> <li><code>W-URL</code>: URL whitelist inspection</li> <li><code>URL</code>: URL blacklist inspection</li> <li><code>ARGS</code>: URL parameter (query string) blacklist inspection</li> <li><code>UA</code>: User-Agent blacklist inspection</li> <li><code>W-REFERER</code>: Referer whitelist inspection</li> <li><code>REFERER</code>: Referer blacklist inspection</li> <li><code>COOKIE</code>: Cookie blacklist inspection</li> <li><code>ADV</code>: Advanced rules.</li></ul> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p><code>str</code> must be wrapped in single or double quotes, and <code>str</code> must contain all of the inspection process.</p></div> <div class="custom-block tip"><p class="custom-block-title">CHANGES IN LATEST 'Current' VERSION</p> <ul><li>default: waf_priority &quot;W-IP IP VERIFY-BOT CC CAPTCHA UNDER-ATTACK W-URL URL ARGS UA W-REFERER REFERER COOKIE POST MODSECURITY&quot;</li></ul> <hr> <ul><li><code>VERIFY-BOT</code>: friendly crawler verification.</li> <li><code>CAPTCHA</code>: Captcha.</li> <li><code>POST</code>: Request body blacklist.</li> <li><code>ModSecurity</code>.</li> <li><code>ADV</code>: Removed.</li></ul></div> <h2 id="waf-http-status"><a href="#waf-http-status" class="header-anchor">#</a> <code>waf_http_status</code></h2> <ul><li>syntax: waf_http_status [general=<em>http_status_code</em>] [cc_deny=<em>http_status_code</em>]</li> <li>default: waf_http_status general=403 cc_deny=503</li> <li>context: http, server, location</li></ul> <p>This directive is used to set the HTTP status code returned when a request is blocked.</p> <ul><li><code>general</code>: Indicates the HTTP status code returned when all blacklist-based inpection are triggered.</li> <li><code>cc_deny</code>: Indicates the HTTP status code returned when CC protection is triggered.</li></ul> <div class="custom-block warning"><p class="custom-block-title">CHANGES IN LATEST 'Current' VERSION</p> <p>This directive has been removed from <code>v10.0.0</code> and the associated features moved to directive <a href="#waf-action">waf_action</a>.</p></div> <h2 id="waf-action"><a href="#waf-action" class="header-anchor">#</a> <code>waf_action</code></h2> <ul><li>syntax: waf_action [blacklist=<em>action</em>] [cc_deny=<em>action</em>] [modsecurity=<em>action</em>] [verify_bot=<em>action</em>] [zone=<em>name:tag</em>]</li> <li>default: waf_action <em>blacklist=403</em> <em>cc_deny=503</em> <em>modsecurity=follow</em> <em>verify_bot=403</em></li> <li>context: http, server, location</li></ul> <p>This directive is used to set the action to be taken when blocking a request. <code>action</code> indicates a specific action and can be the following values.</p> <ul><li><code>4xx | 5xx</code>：HTTP response code.</li> <li><code>CAPTCHA</code>：Use the CAPTCHA to challenge.</li> <li><code>follow</code>：Follow the action of Modsecurity's rule, only for parameter <code>modsecurity</code>.</li></ul> <p>parameters:</p> <ul><li><code>blacklist</code>: All blacklist-based rules, such as IP blacklist, User-Agent blacklist, URL blacklist, etc.</li> <li><code>cc_deny</code>: CC protection.</li> <li><code>modsecurity</code>：ModSecurity's rules.</li> <li><code>verify_bot</code>：<a href="#waf-verify-bot">waf_verify_bot</a>.</li> <li><code>zone</code>：Set the shared memory used to record the necessary information, if and only if an <code>action</code> is <code>CAPTCHA</code>.</li></ul> <h2 id="waf-block-page"><a href="#waf-block-page" class="header-anchor">#</a> <code>waf_block_page</code></h2> <ul><li>syntax: waf_block_page &lt; <em>default</em> | <em>path/to/file.html</em> &gt;</li> <li>default: ——</li> <li>context: http, server, location</li></ul> <p>Used to set the page returned when a request is blocked, <code>default</code> is a built-in HTML file from <code>assets/block.html</code>,
[DATA EXPUNGED] is [DATA EXPUNGED].</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ADD-SP/ngx_waf-docs/edit/master/docs/advance/directive.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ngx_waf-docs/guide/faq.html" class="prev">
        FAQ
      </a></span> <span class="next"><a href="/ngx_waf-docs/advance/rule.html">
        Rule Description
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/ngx_waf-docs/assets/js/app.18b0a3f1.js" defer></script><script src="/ngx_waf-docs/assets/js/2.3e4049ee.js" defer></script><script src="/ngx_waf-docs/assets/js/1.632eea70.js" defer></script><script src="/ngx_waf-docs/assets/js/23.3534e7c2.js" defer></script><script src="/ngx_waf-docs/assets/js/4.14d7d714.js" defer></script>
  </body>
</html>
