<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>最新版（Current） | ngx_waf</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/ADD-SP/ngx_waf@master/assets/logo.png">
    <meta name="description" content="使用简单的 nginx 防火墙模块">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex, noodp, notranslate, max-video-preview:-1">
    
    <link rel="preload" href="/ngx_waf-docs/assets/css/0.styles.692fb11e.css" as="style"><link rel="preload" href="/ngx_waf-docs/assets/js/app.18b0a3f1.js" as="script"><link rel="preload" href="/ngx_waf-docs/assets/js/2.3e4049ee.js" as="script"><link rel="preload" href="/ngx_waf-docs/assets/js/1.632eea70.js" as="script"><link rel="preload" href="/ngx_waf-docs/assets/js/66.c4e0ff1d.js" as="script"><link rel="prefetch" href="/ngx_waf-docs/assets/js/10.dbe56695.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/11.3ce229d2.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/12.6df2a13c.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/13.2fbc14fb.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/14.79f0bc94.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/15.a9c75a53.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/16.90f412f5.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/17.5a0da591.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/18.00741604.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/19.2df6684e.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/20.e4d75808.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/21.0376e09e.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/22.8cd93f05.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/23.3534e7c2.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/24.542f1cdb.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/25.a81f82fc.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/26.518e0279.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/27.9e1df40c.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/28.6a196960.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/29.f98a7279.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/3.c9caeb98.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/30.47624d64.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/31.1c13a39c.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/32.5fe17366.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/33.f0d975ea.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/34.78aa9f6f.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/35.e7283fb6.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/36.f394b95e.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/37.2a10db91.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/38.2f464d46.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/39.98a34cfd.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/4.14d7d714.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/40.07bcf6b0.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/41.d175aa1e.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/42.41c12642.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/43.692e3aac.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/44.89739f3f.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/45.e4fd3ab6.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/46.e62f6898.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/47.ab95c6c5.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/48.c7530b9a.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/49.0249b3b4.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/5.aa966c18.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/50.775910db.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/51.44550aa5.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/52.24cf39ae.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/53.78cfc18d.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/54.fd108f23.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/55.a9734a43.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/56.dabfbc19.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/57.674c5c64.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/58.439ffb3f.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/59.83d2cd2d.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/6.63e6a7bb.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/60.c62e8958.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/61.351cad9c.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/62.135948fd.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/63.a59ca98e.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/64.a63032c9.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/65.b30eba0a.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/67.98a6c2e2.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/68.ec463ee0.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/69.210eed00.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/7.a02e05ba.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/70.de7d7876.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/71.fbb3679c.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/72.cb3c8b40.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/73.df3dbfd5.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/74.f9f9a7b5.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/75.c5d27717.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/76.a123d687.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/77.8447f073.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/78.5465da14.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/79.c5642884.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/80.2c31ee90.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/81.b68da930.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/82.d8bb7f68.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/83.71fa47bc.js"><link rel="prefetch" href="/ngx_waf-docs/assets/js/vendors~docsearch.e06e619e.js">
    <link rel="stylesheet" href="/ngx_waf-docs/assets/css/0.styles.692fb11e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ngx_waf-docs/zh-cn/" class="home-link router-link-active"><!----> <span class="site-name">ngx_waf</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/ngx_waf-docs/zh-cn/practice/overview.html" class="nav-link">
  最佳实践
</a></div><div class="nav-item"><a href="/ngx_waf-docs/zh-cn/advance/upgrade.html" class="nav-link">
  跨版本升级
</a></div><div class="nav-item"><a href="/ngx_waf-docs/zh-cn/changes/overview.html" class="nav-link">
  更新日志
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ngx_waf-docs/changes/current.html" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/ngx_waf-docs/zh-cn/changes/current.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/ADD-SP/ngx_waf/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/ngx_waf-docs/zh-cn/practice/overview.html" class="nav-link">
  最佳实践
</a></div><div class="nav-item"><a href="/ngx_waf-docs/zh-cn/advance/upgrade.html" class="nav-link">
  跨版本升级
</a></div><div class="nav-item"><a href="/ngx_waf-docs/zh-cn/changes/overview.html" class="nav-link">
  更新日志
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ngx_waf-docs/changes/current.html" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/ngx_waf-docs/zh-cn/changes/current.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/ADD-SP/ngx_waf/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf-docs/zh-cn/guide/overview.html" class="sidebar-heading clickable open"><span>快速上手</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/ngx_waf-docs/zh-cn/guide/overview.html" class="sidebar-link">简介</a></li><li><a href="/ngx_waf-docs/zh-cn/guide/version.html" class="sidebar-link">版本说明</a></li><li><a href="/ngx_waf-docs/zh-cn/guide/compatibility.html" class="sidebar-link">兼容性说明</a></li><li><a href="/ngx_waf-docs/zh-cn/guide/installation.html" class="sidebar-link">安装</a></li><li><a href="/ngx_waf-docs/zh-cn/guide/configuration.html" class="sidebar-link">配置</a></li><li><a href="/ngx_waf-docs/zh-cn/guide/test.html" class="sidebar-link">测试</a></li><li><a href="/ngx_waf-docs/zh-cn/guide/faq.html" class="sidebar-link">常见问题与解答</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf-docs/zh-cn/advance/directive.html" class="sidebar-heading clickable"><span>进阶指南</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/ngx_waf-docs/zh-cn/roadmap/overview.html" class="sidebar-link">开发计划（建议征集）</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="更新日志-current"><a href="#更新日志-current" class="header-anchor">#</a> 更新日志（Current）</h1> <p>本文件的格式基于<a href="https://keepachangelog.com/zh-CN/1.0.0" target="_blank" rel="noopener noreferrer">如何维护更新日志<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，
并且本项目遵守<a href="https://semver.org/lang/zh-CN/spec/v2.0.0.html" target="_blank" rel="noopener noreferrer">语义化版本<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="custom-block tip"><p class="custom-block-title">何为「不兼容的修改」？</p> <ul><li>原有的配置文件可能无法使用，比如删除或者重命名了某个配置项。</li></ul></div> <h2 id="未发布"><a href="#未发布" class="header-anchor">#</a> [未发布]</h2> <h3 id="新增"><a href="#新增" class="header-anchor">#</a> 新增</h3> <h3 id="移除"><a href="#移除" class="header-anchor">#</a> 移除</h3> <h3 id="变动"><a href="#变动" class="header-anchor">#</a> 变动</h3> <h3 id="修复"><a href="#修复" class="header-anchor">#</a> 修复</h3> <hr> <h2 id="_10-1-2-2022-07-09-utc-0800"><a href="#_10-1-2-2022-07-09-utc-0800" class="header-anchor">#</a> [10.1.2] - 2022-07-09 UTC+0800</h2> <h3 id="修复-2"><a href="#修复-2" class="header-anchor">#</a> 修复</h3> <ul><li>兼容 <code>nginx-1.23.0</code>。</li></ul> <hr> <h2 id="_10-1-1-2022-01-07-utc-0800"><a href="#_10-1-1-2022-01-07-utc-0800" class="header-anchor">#</a> [10.1.1] - 2022-01-07 UTC+0800</h2> <h3 id="新增-2"><a href="#新增-2" class="header-anchor">#</a> 新增</h3> <ul><li>支持 PCRE2。</li></ul> <h3 id="修复-3"><a href="#修复-3" class="header-anchor">#</a> 修复</h3> <ul><li><p>内存泄漏。</p></li> <li><p>验证码和 Under Attack Mode（五秒盾）有时会无限刷新。</p></li></ul> <hr> <h2 id="_10-1-0-2021-12-14-utc-0800"><a href="#_10-1-0-2021-12-14-utc-0800" class="header-anchor">#</a> [10.1.0] - 2021-12-14 UTC+0800</h2> <h3 id="新增-3"><a href="#新增-3" class="header-anchor">#</a> 新增</h3> <ul><li><p>指令 <code>waf</code> 可以设置为 <code>bypass</code> 模式，即仅检测并记录日志，但不会拦截任何请求。</p></li> <li><p>指令 <code>waf_verify_bot</code> 新增了参数 <code>SogouSpider</code>，用于验证是否为搜狗爬虫。</p></li></ul> <h3 id="修复-4"><a href="#修复-4" class="header-anchor">#</a> 修复</h3> <ul><li><p>内存回收机制并未正常运行，这虽然不会造成内存泄漏，但会导致内存占用居高不下，并引发性能问题。</p></li> <li><p>友好爬虫验证功能会错误地打印拦截日志。</p></li></ul> <hr> <h2 id="_10-0-1-2021-12-05-utc-0800"><a href="#_10-0-1-2021-12-05-utc-0800" class="header-anchor">#</a> [10.0.1] - 2021-12-05 UTC+0800</h2> <h3 id="新增-4"><a href="#新增-4" class="header-anchor">#</a> 新增</h3> <ul><li>添加了两个彩蛋，你可以在文档中找到相关的线索。这两个彩蛋不会自动触发，所以不会影响正常使用。</li></ul> <h3 id="修复-5"><a href="#修复-5" class="header-anchor">#</a> 修复</h3> <ul><li>指令 <code>waf_mode</code> 中所有与请求方法对应的参数均失效。</li></ul> <hr> <h2 id="_10-0-0-2021-11-30-utc-0800"><a href="#_10-0-0-2021-11-30-utc-0800" class="header-anchor">#</a> [10.0.0] - 2021-11-30 UTC+0800</h2> <h3 id="新增-5"><a href="#新增-5" class="header-anchor">#</a> 新增</h3> <ul><li><p>新指令 <code>waf_zone</code>，用来声明一块共享内存，这块内存将被用于其他的指令，比如 <code>waf_cc_deny</code>。</p></li> <li><p>新指令 <code>waf_action</code>，用于设置拦截请求后的动作，比如返回特定的状态码或者使用验证码对客户端做人机认证。</p></li> <li><p>新指令 <code>waf_block_page</code>，用于设置拦截页面，当请求被拦截后将指定的 HTML 文件返回。</p></li> <li><p>新内置变量 <code>$waf_rate</code>，用来表示一个统计周期内当前 IP 的访问次数。统计周期由指令 <code>waf_cc_deny</code> 的参数 <code>rate</code> 决定，如果 IP 已经被拉黑，则由参数 <code>duration</code> 决定。</p></li> <li><p>指令 <code>waf_captcha</code> 增加了一个参数 <code>max_fails</code>，用来设置验证码最大试错次数和超出后的拉黑时间。</p></li> <li><p>指令 <code>waf_captcha</code> 增加了一个参数 <code>zone</code>，用来指定一块共享内存，当且仅当设置了参数 <code>max_fails</code> 时才需要设置。</p></li> <li><p>指令 <code>waf_captcha</code> 增加了一个参数 <code>sitekey</code>，当且仅当省略了参数 <code>file</code> 时才需要设置。</p></li> <li><p>当你重载 nginx 时，模块会尽可能地保留共享内存中的信息，使其不被清空，比如 CC 防护的拉黑列表。</p></li></ul> <h3 id="移除-2"><a href="#移除-2" class="header-anchor">#</a> 移除</h3> <ul><li><p>移除了指令 <code>waf_http_status</code>，相关的功能合并到指令 <code>waf_action</code>。</p></li> <li><p>移除了指令 <code>waf_cc_deny</code> 的参数 <code>size</code>，现在使用 <code>zone</code> 代替。</p></li></ul> <h3 id="变动-2"><a href="#变动-2" class="header-anchor">#</a> 变动</h3> <ul><li><p>允许省略指令 <code>waf_under_attack</code> 的参数 <code>file</code>，省略此参数时将使用一个内置的文件，它来自 <code>assets/under_attack.html</code>。</p></li> <li><p>允许省略指令 <code>waf_captcha</code> 的参数 <code>file</code>，省略此参数时将根据参数 <code>prov</code> 的值使用一个内置的文件，这些文件来自目录 <code>assets/</code>。</p></li> <li><p>更多的调试日志。</p></li></ul> <hr> <h2 id="_9-0-6-2021-10-10-utc-0800"><a href="#_9-0-6-2021-10-10-utc-0800" class="header-anchor">#</a> [9.0.6] - 2021-10-10 UTC+0800</h2> <h3 id="修复-6"><a href="#修复-6" class="header-anchor">#</a> 修复</h3> <ul><li>当指令 <code>try_files</code> 生效时无法完成 CAPTCHA 的验证。</li></ul> <hr> <h2 id="_9-0-5-2021-10-09-utc-0800"><a href="#_9-0-5-2021-10-09-utc-0800" class="header-anchor">#</a> [9.0.5] - 2021-10-09 UTC+0800</h2> <h3 id="新的测试套件"><a href="#新的测试套件" class="header-anchor">#</a> 新的测试套件</h3> <p>偶然间看到了一个测试套件：<a href="https://github.com/openresty/test-nginx" target="_blank" rel="noopener noreferrer">test-nginx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。
看完之后感觉很好便拿来测试，编了不少测试用例，果不其然发现了一大堆 Bug，不愧是我。</p> <h3 id="变动-3"><a href="#变动-3" class="header-anchor">#</a> 变动</h3> <ul><li><p>删除了无用的调试日志。</p></li> <li><p>更多的调试日志。</p></li></ul> <h3 id="修复-7"><a href="#修复-7" class="header-anchor">#</a> 修复</h3> <ul><li><p>有时连接会被过早地关闭。</p></li> <li><p>启用 CAPTCHA 后请求体的检测结果可能会出错。</p></li> <li><p>CAPTCHA 可能会因为 HTTP 缓存而失败。</p></li> <li><p>重载 nginx 时存在内存泄露。</p></li> <li><p>未能正确合并上层配置块的 <code>waf_cache</code> 指令。</p></li> <li><p>未能正确合并上层配置块的 <code>waf_cc_deny</code> 指令。</p></li> <li><p>未能正确继承上层配置块的 Referer 黑名单。</p></li> <li><p>未能正确识别一些错误的配置。</p></li> <li><p>修复了一条默认的 URL 黑名单规则。</p></li> <li><p>修复了下列文件，使得验证码完成后可以自动刷新网页。</p> <ul><li><code>assets/hCaptcha.html</code></li> <li><code>assets/reCAPTCHAv2_Checkbox.html</code></li> <li><code>assets/reCAPTCHAv2_Invisible.html</code></li> <li><code>assets/reCAPTCHAv3.html</code></li></ul></li></ul> <hr> <h2 id="_9-0-4-2021-09-29-utc-0800"><a href="#_9-0-4-2021-09-29-utc-0800" class="header-anchor">#</a> [9.0.4] - 2021-09-29 UTC+0800</h2> <h3 id="修复-8"><a href="#修复-8" class="header-anchor">#</a> 修复</h3> <ul><li>当指令 <code>rewrite</code> 造成内部重定向时会错误地跳过所有检测。</li></ul> <hr> <h2 id="_9-0-3-2021-09-28-utc-0800"><a href="#_9-0-3-2021-09-28-utc-0800" class="header-anchor">#</a> [9.0.3] - 2021-09-28 UTC+0800</h2> <h3 id="变动-4"><a href="#变动-4" class="header-anchor">#</a> 变动</h3> <ul><li>更多的调试日志。</li></ul> <h3 id="修复-9"><a href="#修复-9" class="header-anchor">#</a> 修复</h3> <ul><li>验证码页面不能正常显示。</li></ul> <hr> <h2 id="_9-0-2-2021-09-25-utc-0800"><a href="#_9-0-2-2021-09-25-utc-0800" class="header-anchor">#</a> [9.0.2] - 2021-09-25 UTC+0800</h2> <h3 id="修复-10"><a href="#修复-10" class="header-anchor">#</a> 修复</h3> <ul><li>内置变量 <code>$waf_blocking_log</code> 的值有时会出错。</li></ul> <hr> <h2 id="_9-0-1-2021-09-24-utc-0800"><a href="#_9-0-1-2021-09-24-utc-0800" class="header-anchor">#</a> [9.0.1] - 2021-09-24 UTC+0800</h2> <h3 id="修复-11"><a href="#修复-11" class="header-anchor">#</a> 修复</h3> <ul><li>未能正确读取 ModSecurity 的规则。</li></ul> <hr> <h2 id="_9-0-0-2021-09-23-utc-0800"><a href="#_9-0-0-2021-09-23-utc-0800" class="header-anchor">#</a> [9.0.0] - 2021-09-23 UTC+0800</h2> <h3 id="注意"><a href="#注意" class="header-anchor">#</a> <strong>注意</strong></h3> <p>如果您想要升级到此版本，请查看文档中的跨版本升级的指南。</p> <h3 id="新增-6"><a href="#新增-6" class="header-anchor">#</a> 新增</h3> <ul><li><p>兼容了<a href="https://github.com/SpiderLabs/ModSecurity" target="_blank" rel="noopener noreferrer">ModSecurity<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的规则。</p></li> <li><p>增加了两个指令：<code>waf_modsecurity</code> 和 <code>waf_modsecurity_transaction_id</code>。</p></li> <li><p>为指令 <code>waf_priority</code> 增加了参数 <code>MODSECURITY</code>。</p></li></ul> <h3 id="移除-3"><a href="#移除-3" class="header-anchor">#</a> 移除</h3> <ul><li><p>删除了指令 <code>waf_mode</code> 的一些参数：<code>LIBINJECTION</code>、<code>LIBINJECTION-SQLI</code>、<code>LIBINJECTION-XSS</code> 和 <code>ADV</code>。</p></li> <li><p>删除了指令 <code>waf_priority</code> 的参数 <code>ADV</code>。</p></li> <li><p>删除了依赖 <a href="https://github.com/libinjection/libinjection" target="_blank" rel="noopener noreferrer">libinjection<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></li></ul> <h3 id="修复-12"><a href="#修复-12" class="header-anchor">#</a> 修复</h3> <ul><li><p>当验证码通过时不再返回 404 状态码，而是返回 204 状态码。</p></li> <li><p>有时不会完整地检查请求体。</p></li></ul> <hr> <h2 id="_8-0-3-2021-08-27-utc-0800"><a href="#_8-0-3-2021-08-27-utc-0800" class="header-anchor">#</a> [8.0.3] - 2021-08-27 UTC+0800</h2> <h3 id="修复-13"><a href="#修复-13" class="header-anchor">#</a> 修复</h3> <ul><li><p>内存泄露</p></li> <li><p>一个没有初始化的结构体字段，会导致错误日志中出现大量的 <code>malloc(size) failed (12: Out of memory)</code>。</p></li></ul> <hr> <h2 id="_8-0-2-2021-08-27-utc-0800"><a href="#_8-0-2-2021-08-27-utc-0800" class="header-anchor">#</a> [8.0.2] - 2021-08-27 UTC+0800</h2> <h3 id="修复-14"><a href="#修复-14" class="header-anchor">#</a> 修复</h3> <ul><li><p>开启验证码后 nginx 崩溃（段错误），原因是未能正确合并不同级别的 <code>waf_captcha</code> 指令。</p></li> <li><p>不能显示验证码页面，原因是未能正确合并不同级别的 <code>waf_captcha</code> 指令。</p></li> <li><p>如果使用了 <code>proxy_pass</code> 指令，Under-Attack-Mode 和验证码均不能正常工作。</p></li></ul> <hr> <h2 id="_8-0-1-2021-08-23-utc-0800"><a href="#_8-0-1-2021-08-23-utc-0800" class="header-anchor">#</a> [8.0.1] - 2021-08-23 UTC+0800</h2> <h3 id="新增-7"><a href="#新增-7" class="header-anchor">#</a> 新增</h3> <ul><li>当 CC 防护返回 444 状态码时不再生成额外的响应头。</li></ul> <h3 id="修复-15"><a href="#修复-15" class="header-anchor">#</a> 修复</h3> <ul><li><p>当 <code>User-Agent</code> 为空时会引发段错误。</p></li> <li><p>不能正确合并指令 <code>waf_http_status</code>。</p></li></ul> <hr> <h2 id="_8-0-0-2021-08-21-utc-0800"><a href="#_8-0-0-2021-08-21-utc-0800" class="header-anchor">#</a> [8.0.0] - 2021-08-21 UTC+0800</h2> <h3 id="注意-2"><a href="#注意-2" class="header-anchor">#</a> <strong>注意</strong></h3> <p>如果您想要升级到此版本，请查看文档中的跨版本升级的指南。</p> <h3 id="新增-8"><a href="#新增-8" class="header-anchor">#</a> 新增</h3> <ul><li><p>引入了第三方平台的验证码，支持 hCaptcha、reCAPTCHAv2 和 reCAPTCHAv3，相关的指令为 <code>waf_captcha</code>。</p></li> <li><p>支持识别友好爬虫，包括 GooleBot、BingBot、BaiduSpider 和 YandexBot，识别成功后自动放行，相关的指令为 <code>waf_verify_bot</code>。</p></li> <li><p>CC 防护支持开启验证码模式，开启后当请求频率超出限制后会启用验证码，如果连续三次验证失败则拉黑 IP，反之则重新统计请求频率。</p></li></ul> <h3 id="变动-5"><a href="#变动-5" class="header-anchor">#</a> 变动</h3> <ul><li><p>指令 <code>waf_mode</code> 的语法有所变化，详见文档中的跨版本升级的指南。</p></li> <li><p>指令 <code>waf_cc_deny</code> 的语法有所变化，详见文档中的跨版本升级的指南。</p></li> <li><p>指令 <code>waf_cache</code> 的语法有所变化，详见文档中的跨版本升级的指南。</p></li> <li><p>支持修改「请求体检查」的优先级。</p></li></ul> <h3 id="移除-4"><a href="#移除-4" class="header-anchor">#</a> 移除</h3> <ul><li>移除了指令 <code>waf_cache</code> 的两个参数，分别是 <code>interval</code> 和 <code>percent</code>。</li></ul> <hr> <h2 id="_7-1-0-2021-08-16-utc-0800"><a href="#_7-1-0-2021-08-16-utc-0800" class="header-anchor">#</a> [7.1.0] - 2021-08-16 UTC+0800</h2> <h3 id="新增-9"><a href="#新增-9" class="header-anchor">#</a> 新增</h3> <ul><li>配置项 <code>waf_cc_deny</code> 的参数 <code>rate</code> 允许更多个格式，如 <code>500r/s</code>、<code>500r/60s</code>、<code>500r/m</code>、<code>500r/60m</code>、<code>500r/h</code>、<code>500r/60h</code> 和 <code>500r/d</code>。</li></ul> <hr> <h2 id="_7-0-1-2021-08-11-utc-0800"><a href="#_7-0-1-2021-08-11-utc-0800" class="header-anchor">#</a> [7.0.1] - 2021-08-11 UTC+0800</h2> <h3 id="修复-16"><a href="#修复-16" class="header-anchor">#</a> 修复</h3> <ul><li><p>不能正确解析 IP 黑白名单中的 <code>0.0.0.0/0</code>。</p></li> <li><p>兼容不支持 IPV6 的运行环境。</p></li></ul> <hr> <h2 id="_7-0-0-2021-08-04-utc-0800"><a href="#_7-0-0-2021-08-04-utc-0800" class="header-anchor">#</a> [7.0.0] - 2021-08-04 UTC+0800</h2> <h3 id="变动-6"><a href="#变动-6" class="header-anchor">#</a> 变动</h3> <ul><li><p>改变了 Under Attack Mode 的实现方式。不再使用重定向实现，而是通过修改响应体实现。</p></li> <li><p>删除了配置项 <code>waf_under_attack</code> 的参数 <code>uri</code>，详情见文档。</p></li> <li><p>为配置项 <code>waf_under_attack</code> 增加了一个参数 <code>file</code>，该参数的值应该是一个 HTML 文件的绝对路径，详情见文档。</p></li> <li><p>不允许在 <code>http</code> 这一级中使用配置项 <code>waf_cc_deny</code>。</p></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ADD-SP/ngx_waf-docs/edit/master/docs/zh-cn/changes/current.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/ngx_waf-docs/assets/js/app.18b0a3f1.js" defer></script><script src="/ngx_waf-docs/assets/js/2.3e4049ee.js" defer></script><script src="/ngx_waf-docs/assets/js/1.632eea70.js" defer></script><script src="/ngx_waf-docs/assets/js/66.c4e0ff1d.js" defer></script>
  </body>
</html>
